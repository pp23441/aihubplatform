{% extends "layout.html" %}
{% block content %}

<style>
.card {
    background: #020617;
    padding: 15px;
    border-radius: 10px;
    margin-bottom: 20px;
}
input, select, button {
    width: 100%;
    padding: 10px;
    margin-bottom: 10px;
    border-radius: 6px;
    border: 1px solid #334155;
    background: #020617;
    color: #e5e7eb;
}
button {
    background: #38bdf8;
    color: #020617;
    font-weight: bold;
    cursor: pointer;
}
button:hover {
    background: #0ea5e9;
}
table {
    width: 100%;
    border-collapse: collapse;
}
th, td {
    padding: 10px;
    border-bottom: 1px solid #334155;
    text-align: left;
}
th {
    background: #020617;
}
small {
    color: #94a3b8;
}
.filter-row {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}
.filter-row > div {
    flex: 1;
}
</style>

<h1>ğŸ›’ Smart Store Finder</h1>

<!-- FILTER PANEL -->
<div class="card">
    <h2>ğŸ” Filters</h2>

    <form method="GET" id="filterForm">

        <!-- LOCATION -->
        <label>ğŸ“ Location</label>
        <input
            type="text"
            name="location"
            placeholder="City / area / postcode"
            value="{{ location if location != 'Your Location' else '' }}"
        >

        <button type="button" onclick="useMyLocation()">
            ğŸ“¡ Use My Current Location
        </button>

        <!-- PRODUCT -->
        <label>ğŸ› Product / Service</label>
        <input
            type="text"
            name="product"
            placeholder="Type ANY product or service (e.g. iPhone, shoes, groceries, repair)"
            value="{{ product or '' }}"
            required
        >
        <small>You can search for any product or service â€” no limitations.</small>

        <!-- DISTANCE -->
        <label>
            ğŸ“ Distance:
            <strong>
                <span id="rangeValue">{{ range_value }}</span>
                {{ unit }}
            </strong>
        </label>

        <input
            type="range"
            min="0"
            max="20"
            value="{{ range_value }}"
            name="range"
            id="rangeSlider"
        >

        <!-- UNIT -->
        <div class="filter-row">
            <div>
                <label>
                    <input type="radio" name="unit" value="km"
                        {% if unit == "km" %}checked{% endif %}>
                    Kilometers
                </label>
            </div>
            <div>
                <label>
                    <input type="radio" name="unit" value="mile"
                        {% if unit == "mile" %}checked{% endif %}>
                    Miles
                </label>
            </div>
        </div>

        <!-- RATING + OPEN -->
        <div class="filter-row">
            <div>
                <label>â­ Minimum Rating</label>
                <select name="rating">
                    <option value="0">Any</option>
                    <option value="3">3+ â­</option>
                    <option value="4">4+ â­</option>
                </select>
            </div>
            <div>
                <label>
                    <input type="checkbox" name="open_now" value="1"
                        {% if open_now %}checked{% endif %}>
                    â° Open Now
                </label>
            </div>
        </div>

        <button type="submit">ğŸš€ Apply Filters</button>
    </form>
</div>

<!-- AI RECOMMENDATION -->
{% if ai_product %}
<div class="card">
    <h2>ğŸ¤– AI Recommendation</h2>
    <p>
        <strong>{{ ai_product.product }}</strong><br>
        ğŸª {{ ai_product.store }}<br>
        ğŸ§  {{ ai_product.reason }}
    </p>
</div>
{% endif %}

<!-- STORE LIST -->
{% if stores %}
<div class="card">
    <h2>ğŸª Nearby Stores ({{ location }})</h2>

    <table>
        <tr>
            <th>Store</th>
            <th>Address</th>
            <th>Rating</th>
            <th>Open</th>
            <th>Distance</th>
            <th>Estimated Price</th>
            <th>Website</th>
        </tr>

        {% for s in stores %}
        <tr>
            <td><strong>{{ s.name }}</strong></td>
            <td>{{ s.address }}</td>
            <td>{{ s.rating }} â­</td>
            <td>{{ "Yes" if s.open_now else "No" }}</td>
            <td>{{ s.distance_km }} km</td>
            <td>{{ s.estimated_price }}</td>
            <td>
                {% if s.website %}
                <a href="{{ s.website }}" target="_blank">Visit</a>
                {% else %}N/A{% endif %}
            </td>
        </tr>
        {% endfor %}
    </table>
</div>
{% endif %}

<!-- MAP -->
{% if lat and lon %}
<div class="card">
    <h2>ğŸ—º Map View</h2>
    <div id="map" style="height:400px; border-radius:10px;"></div>
</div>
{% endif %}

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
function useMyLocation() {
    navigator.geolocation.getCurrentPosition(pos => {
        const form = document.getElementById("filterForm");

        let lat = document.createElement("input");
        lat.type = "hidden";
        lat.name = "lat";
        lat.value = pos.coords.latitude;

        let lon = document.createElement("input");
        lon.type = "hidden";
        lon.name = "lon";
        lon.value = pos.coords.longitude;

        form.appendChild(lat);
        form.appendChild(lon);
        form.submit();
    });
}

const slider = document.getElementById("rangeSlider");
const valueLabel = document.getElementById("rangeValue");
slider.oninput = () => valueLabel.innerText = slider.value;

{% if lat and lon %}
const map = L.map('map').setView([{{ lat }}, {{ lon }}], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

L.marker([{{ lat }}, {{ lon }}])
    .addTo(map)
    .bindPopup("ğŸ“ You are here");

{% for s in stores %}
L.marker([{{ s.lat }}, {{ s.lon }}])
    .addTo(map)
    .bindPopup("<b>{{ s.name }}</b><br>{{ s.address }}");
{% endfor %}
{% endif %}
</script>

{% endblock %}
